@attribute [Route(PageUrls.AbhayYojana)]
@attribute [Route("{culture?}" + PageUrls.AbhayYojana)]
@attribute [Authorize(Policy = AuthPolicies.PRIVILEGED_ACCESS)]
@inherits AppPageBase

@using Bit.BlazorUI
@using System.Linq
@using System.IO
@using ClosedXML.Excel
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using SRAAI.Shared.Dtos.AbhayYojana

<AppPageData Title="Abhay Yojana Applications"
             PageTitle="Abhay Yojana Applications" />

<section>
    <BitStack Gap="20" Style="padding:20px; font-family:'Segoe UI', Arial, sans-serif;">

        <BitText Typography="BitTypography.Subtitle1"
                 Style="font-size:22px; font-weight:700; color:var(--bit-color-fg); margin-bottom:8px;">
            Import & Export Excel Data
        </BitText>

        <!-- Action Buttons in a Card -->
        <div style="background:white; padding:16px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <BitStack Horizontal HorizontalAlign="BitAlignment.Start" Gap="14px" Style="flex-wrap:wrap;">

                <BitFileUpload @ref="fileUploadRef"
                               AutoReset
                               AutoUpload
                               HideFileView
                               Accept=".xlsx"
                               MaxSize="1024 * 1024 * 50"
                               UploadUrlProvider="GetUploadUrl"
                               UploadRequestHttpHeadersProvider="GetUploadRequestHeaders"
                               OnUploading="() => isBusy = true"
                               OnUploadFailed="HandleUploadFailed"
                               OnUploadComplete="HandleUploadComplete">
                    <LabelTemplate>
                        <BitButton IconName="@BitIconName.ExcelDocument"
                                   Style="background:#0078d4; color:white; border-radius:8px; padding:10px 18px;
                                          font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition:0.3s;"
                                   Class="btn-hover"
                                   Disabled="isBusy"
                                   OnClick="() => fileUploadRef.Browse()">
                            Import Original Annexure2
                        </BitButton>
                    </LabelTemplate>
                </BitFileUpload>

                <BitButton IconName="@BitIconName.ExcelLogo"
                           Style="background:#f39c12; color:white; border-radius:8px; padding:10px 18px;
                                  font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition:0.3s;"
                           Class="btn-hover"
                           OnClick="ExportToExcel">
                    Export latest Annexure
                </BitButton>

                <BitFileUpload @ref="fileUpdateRef"
                               AutoReset
                               AutoUpload
                               HideFileView
                               Accept=".xlsx"
                               MaxSize="1024 * 1024 * 50"
                               UploadUrlProvider="GetUpdateUploadUrl"
                               UploadRequestHttpHeadersProvider="GetUpdateUploadRequestHeaders"
                               OnUploading="() => isBusy = true"
                               OnUploadFailed="HandleUploadFailed"
                               OnUploadComplete="HandleUploadUpdateComplete">
                    <LabelTemplate>
                        <BitButton IconName="@BitIconName.ExcelDocument"
                                   Style="background:#16a085; color:white; border-radius:8px; padding:10px 18px;
                                          font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition:0.3s;"
                                   Class="btn-hover"
                                   Disabled="isBusy"
                                   OnClick="() => fileUpdateRef.Browse()">
                            Import Addendum
                        </BitButton>
                    </LabelTemplate>
                </BitFileUpload>

                <BitButton IconName="@BitIconName.View"
                           Style="background:#28a745; color:white; border-radius:8px; padding:10px 18px;
                                  font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition:0.3s;"
                           Class="btn-hover"
                           OnClick="GoToSummary">
                    View Result
                </BitButton>
            </BitStack>
        </div>

        <!-- Info Section -->
        <div style="margin-top:20px; padding:12px 18px; border-left:4px solid #0078d4; background:#f8f9fa; border-radius:6px;">
            <h3 style="margin:0; font-size:18px; font-weight:600; color:#0078d4;">
                Total Applications : @applications?.Count()
            </h3>
            <p style="margin:0; font-size:15px; color:#555;">
                Last Updated : @applications?.Max(a => a.UpdatedDate)
            </p>
        </div>

        <div style="background:var(--bit-color-bg); font-family:'Segoe UI', Arial, sans-serif;">
            @if (isLoadingApplications)
            {
                <div style="color:var(--bit-color-fg);">Loading...</div>
            }
            else if (applications is not null && applications.Any())
            {
                <table style="width:100%; border-collapse:collapse; font-size:14px; color:var(--bit-color-fg);">
                    <thead style="background:#fdeaea; color:#b71c1c; font-weight:bold;">
                        <tr>
                            <th style="padding:10px; border:1px solid #555;">SR No.</th>
                            <th style="padding:10px; border:1px solid #555;">Slum Number</th>
                            <th style="padding:10px; border:1px solid #555;">Original Dweller</th>
                            <th style="padding:10px; border:1px solid #555;">Applicant Name</th>
                            <th style="padding:10px; border:1px solid #555;">Voter Year</th>
                            <th style="padding:10px; border:1px solid #555;">Voter Part</th>
                            <th style="padding:10px; border:1px solid #555;">Voter Serial</th>
                            <th style="padding:10px; border:1px solid #555;">Voter Bound</th>
                            <th style="padding:10px; border:1px solid #555;">Slum Usage</th>
                            <th style="padding:10px; border:1px solid #555;">Carpet Area (Sq Ft)</th>
                            <th style="padding:10px; border:1px solid #555;">Evidence Details</th>
                            <th style="padding:10px; border:1px solid #555;">Eligibility</th>
                            <th style="padding:10px; border:1px solid #555;">Remarks</th>
                            <th style="padding:10px; border:1px solid #555;">Version</th>
                            <th style="padding:10px; border:1px solid #555;">Created Date</th>
                            <th style="padding:10px; border:1px solid #555;">Updated Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var a in applications)
                        {
                            <tr style="background:@(applications.IndexOf(a) % 2 == 0 ? "var(--bit-color-bg)" : "transparent")">
                                <td style="padding:8px; border:1px solid #555;">@a.SerialNumber</td>
                                <td style="padding:8px; border:1px solid #555;">@a.OriginalSlumNumber</td>
                                <td style="padding:8px; border:1px solid #555;">@a.OriginalSlumDwellerName</td>
                                <td style="padding:8px; border:1px solid #555;">@a.ApplicantName</td>
                                <td style="padding:8px; border:1px solid #555;">@a.VoterListYear</td>
                                <td style="padding:8px; border:1px solid #555;">@a.VoterListPartNumber</td>
                                <td style="padding:8px; border:1px solid #555;">@a.VoterListSerialNumber</td>
                                <td style="padding:8px; border:1px solid #555;">@a.VoterListBound</td>
                                <td style="padding:8px; border:1px solid #555;">@a.SlumUsage</td>
                                <td style="padding:8px; border:1px solid #555;">@a.CarpetAreaSqFt</td>
                                <td style="padding:8px; border:1px solid #555;">@a.EvidenceDetails</td>
                                <td style="padding:8px; border:1px solid #555;">@a.EligibilityStatus</td>
                                <td style="padding:8px; border:1px solid #555;">@a.Remarks</td>
                                <td style="padding:8px; border:1px solid #555;">@a.Version</td>
                                <td style="padding:8px; border:1px solid #555;">@a.CreatedDate</td>
                                <td style="padding:8px; border:1px solid #555;">@a.UpdatedDate</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div style="text-align:center; padding:20px; color:var(--bit-color-fg);">
                    No applications found. Import an Excel file to get started.
                </div>
            }
        </div>
    </BitStack>
</section>

<style>
    .btn-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.25) !important;
    }
</style>

<script>
    function downloadFile(fileName, contentType, base64Data) {
        const link = document.createElement("a");
        link.href = "data:" + contentType + ";base64," + base64Data;
        link.download = fileName;
        link.click();
    }
</script>
