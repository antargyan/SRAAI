@attribute [Route(PageUrls.AbhayYojana)]
@attribute [Route("{culture?}" + PageUrls.AbhayYojana)]
@attribute [Authorize(Policy = AuthPolicies.PRIVILEGED_ACCESS)]
@inherits AppPageBase

@using Bit.BlazorUI
@using System.Linq
@using System.IO
@using ClosedXML.Excel
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using SRAAI.Shared.Dtos.AbhayYojana

<AppPageData Title="Abhay Yojana Applications"
             PageTitle="Abhay Yojana Applications" />

<section>
    <BitStack Gap="16">

        <BitText Typography="BitTypography.Subtitle1"
                 Style="font-size:20px; font-weight:bold; color:var(--bit-color-fg);">
            Import & Export Excel Data
        </BitText>

        <BitStack Horizontal HorizontalAlign="BitAlignment.Start" Gap="12px">

            <BitFileUpload @ref="fileUploadRef"
                           AutoReset
                           AutoUpload
                           HideFileView
                           Accept=".xlsx"
                           MaxSize="1024 * 1024 * 50"
                           UploadUrlProvider="GetUploadUrl"
                           UploadRequestHttpHeadersProvider="GetUploadRequestHeaders"
                           OnUploading="() => isBusy = true"
                           OnUploadFailed="HandleUploadFailed"
                           OnUploadComplete="HandleUploadComplete">
                <LabelTemplate>
                    <BitButton IconName="@BitIconName.ExcelDocument"
                               Style="background:#0078d4; color:white; border-radius:6px; padding:8px 14px;"
                               Disabled="isBusy"
                               OnClick="() => fileUploadRef.Browse()">Import Original Annexure2</BitButton>
                </LabelTemplate>
            </BitFileUpload>

            <BitButton IconName="@BitIconName.ExcelLogo"
                       Style="background:#f39c12; color:white; border-radius:6px; padding:8px 14px;"
                       OnClick="ExportToExcel">Export latest Annexure</BitButton>

            <BitFileUpload @ref="fileUpdateRef"
                           AutoReset
                           AutoUpload
                           HideFileView
                           Accept=".xlsx"
                           MaxSize="1024 * 1024 * 50"
                           UploadUrlProvider="GetUpdateUploadUrl"
                           UploadRequestHttpHeadersProvider="GetUpdateUploadRequestHeaders"
                           OnUploading="() => isBusy = true"
                           OnUploadFailed="HandleUploadFailed"
                           OnUploadComplete="HandleUploadUpdateComplete">
                <LabelTemplate>
                    <BitButton IconName="@BitIconName.ExcelDocument"
                               Style="background:#0078d4; color:white; border-radius:6px; padding:8px 14px;"
                               Disabled="isBusy"
                               OnClick="() => fileUpdateRef.Browse()">Import Addendum</BitButton>
                </LabelTemplate>
            </BitFileUpload>

            <BitButton IconName="@BitIconName.View"
                       Style="background:#28a745; color:white; border-radius:6px; padding:8px 14px;"
                       OnClick="GoToSummary">View Result</BitButton>
        </BitStack>

        <div style="margin-top:10px; margin-bottom:10px;">
            <h3 style="margin:0; font-size:18px; font-weight:600; color:var(--bit-color-fg);">
                Total Applications : @applications?.Count()
            </h3>
            <p style="margin:0; font-size:16px; color:var(--bit-color-fg);">
                Last Updated : @applications?.Max(a => a.UpdatedDate)
            </p>
        </div>

        <div style="background:var(--bit-color-bg);
                    font-family:'Segoe UI', Arial, sans-serif;">
            @if (isLoadingApplications)
            {
                <div style="color:var(--bit-color-fg);">Loading...</div>
            }
            else if (applications is not null && applications.Any())
            {
                <table style="width:100%; border-collapse:collapse; font-size:14px; color:var(--bit-color-fg);">
                    <thead style="background:#fdeaea; color:#b71c1c; font-weight:bold;">
                        <tr>
                            <th style="padding:10px; border:1px solid #555;">SR No.</th>
                            <th style="padding:10px; border:1px solid #555;">Slum Number</th>
                            <th style="padding:10px; border:1px solid #555;">Original Dweller</th>
                            <th style="padding:10px; border:1px solid #555;">Applicant Name</th>
                            <th style="padding:10px; border:1px solid #555;">Voter Year</th>
                            <th style="padding:10px; border:1px solid #555;">Voter Part</th>
                            <th style="padding:10px; border:1px solid #555;">Voter Serial</th>
                            <th style="padding:10px; border:1px solid #555;">Voter Bound</th>
                            <th style="padding:10px; border:1px solid #555;">Slum Usage</th>
                            <th style="padding:10px; border:1px solid #555;">Carpet Area (Sq Ft)</th>
                            <th style="padding:10px; border:1px solid #555;">Evidence Details</th>
                            <th style="padding:10px; border:1px solid #555;">Eligibility</th>
                            <th style="padding:10px; border:1px solid #555;">Remarks</th>
                            <th style="padding:10px; border:1px solid #555;">Version</th>
                            <th style="padding:10px; border:1px solid #555;">Created Date</th>
                            <th style="padding:10px; border:1px solid #555;">Updated Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var a in applications)
                        {
                            <tr style="background:@(applications.IndexOf(a) % 2 == 0 ? "var(--bit-color-bg)" : "transparent")">
                                <td style="padding:8px; border:1px solid #555;">@a.SerialNumber</td>
                                <td style="padding:8px; border:1px solid #555;">@a.OriginalSlumNumber</td>
                                <td style="padding:8px; border:1px solid #555;">@a.OriginalSlumDwellerName</td>
                                <td style="padding:8px; border:1px solid #555;">@a.ApplicantName</td>
                                <td style="padding:8px; border:1px solid #555;">@a.VoterListYear</td>
                                <td style="padding:8px; border:1px solid #555;">@a.VoterListPartNumber</td>
                                <td style="padding:8px; border:1px solid #555;">@a.VoterListSerialNumber</td>
                                <td style="padding:8px; border:1px solid #555;">@a.VoterListBound</td>
                                <td style="padding:8px; border:1px solid #555;">@a.SlumUsage</td>
                                <td style="padding:8px; border:1px solid #555;">@a.CarpetAreaSqFt</td>
                                <td style="padding:8px; border:1px solid #555;">@a.EvidenceDetails</td>
                                <td style="padding:8px; border:1px solid #555;">@a.EligibilityStatus</td>
                                <td style="padding:8px; border:1px solid #555;">@a.Remarks</td>
                                <td style="padding:8px; border:1px solid #555;">@a.Version</td>
                                <td style="padding:8px; border:1px solid #555;">@a.CreatedDate</td>
                                <td style="padding:8px; border:1px solid #555;">@a.UpdatedDate</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div style="text-align:center; padding:20px; color:var(--bit-color-fg);">
                    No applications found. Import an Excel file to get started.
                </div>
            }
        </div>
    </BitStack>
</section>

<script>
    function downloadFile(fileName, contentType, base64Data) {
        const link = document.createElement("a");
        link.href = "data:" + contentType + ";base64," + base64Data;
        link.download = fileName;
        link.click();
    }
</script>