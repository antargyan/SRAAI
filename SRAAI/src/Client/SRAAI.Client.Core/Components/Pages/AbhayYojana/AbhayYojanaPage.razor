@attribute [Route(PageUrls.AbhayYojana)]
@attribute [Route("{culture?}" + PageUrls.AbhayYojana)]
@attribute [Authorize(Policy = AuthPolicies.PRIVILEGED_ACCESS)]
@inherits AppPageBase

@using Bit.BlazorUI
@using System.Linq
@using System.IO
@using ClosedXML.Excel
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using SRAAI.Shared.Dtos.AbhayYojana

<AppPageData Title="Abhay Yojana Applications"
             PageTitle="Abhay Yojana Applications" />

<section>
    <BitStack Gap="16">
        
        <BitText Typography="BitTypography.Subtitle1"
                 Style="font-size:20px; font-weight:bold; color:#333;">
            Import & Export Excel Data
        </BitText>

        <BitStack Horizontal HorizontalAlign="BitAlignment.Start" Gap="12px">
        
            <BitFileUpload @ref="fileUploadRef"
                           AutoReset
                           AutoUpload
                           HideFileView
                           Accept=".xlsx"
                           MaxSize="1024 * 1024 * 50"
                           UploadUrlProvider="GetUploadUrl"
                           UploadRequestHttpHeadersProvider="GetUploadRequestHeaders"
                           OnUploading="() => isBusy = true"
                           OnUploadFailed="HandleUploadFailed"
                           OnUploadComplete="HandleUploadComplete">
                <LabelTemplate>
                    <BitButton IconName="@BitIconName.ExcelDocument"
                               Style="background:#0078d4; color:white; border-radius:6px; padding:8px 14px;"
                               Disabled="isBusy"
                               OnClick="() => fileUploadRef.Browse()">Import Excel</BitButton>
                </LabelTemplate>
            </BitFileUpload>

            <BitButton IconName="@BitIconName.ExcelLogo"
                       Style="background:#f39c12; color:white; border-radius:6px; padding:8px 14px;"
                       OnClick="ExportToExcel">Export to Excel</BitButton>

            <BitButton IconName="@BitIconName.View"
                       Style="background:#28a745; color:white; border-radius:6px; padding:8px 14px;"
                       OnClick="GoToSummary">View Result</BitButton>
        </BitStack>

        <div style="margin-top:10px; margin-bottom:10px;">
            <h3 style="margin:0; font-size:18px; font-weight:600; color:#000;">
                Total Applications : @applications?.Count()
            </h3>
            <p style="margin:0; font-size:18px; font-weight:600; color:#000;">
                Last Updated : @applications?.Max(a => a.UpdatedDate)
            </p>
        </div>

        <div style="padding:12px; border:1px solid #ddd; border-radius:8px; background:#ffffff;
                    font-family:'Segoe UI', Arial, sans-serif; box-shadow:0 1px 4px rgba(0,0,0,0.08);">
            @if (isLoadingApplications)
            {
                <div>Loading...</div>
            }
            else if (applications is not null && applications.Any())
            {
                <table style="width:100%; border-collapse:collapse; font-size:14px;">
                    <thead style="background:#fdeaea; color:#b71c1c; font-weight:bold;">
                        <tr>
                            <th style="padding:10px; border:1px solid #ddd;">SR No.</th>
                            <th style="padding:10px; border:1px solid #ddd;">Slum Number</th>
                            <th style="padding:10px; border:1px solid #ddd;">Original Dweller</th>
                            <th style="padding:10px; border:1px solid #ddd;">Applicant Name</th>
                            <th style="padding:10px; border:1px solid #ddd;">Voter Year</th>
                            <th style="padding:10px; border:1px solid #ddd;">Voter Part</th>
                            <th style="padding:10px; border:1px solid #ddd;">Voter Serial</th>
                            <th style="padding:10px; border:1px solid #ddd;">Voter Bound</th>
                            <th style="padding:10px; border:1px solid #ddd;">Slum Usage</th>
                            <th style="padding:10px; border:1px solid #ddd;">Carpet Area (Sq Ft)</th>
                            <th style="padding:10px; border:1px solid #ddd;">Evidence Details</th>
                            <th style="padding:10px; border:1px solid #ddd;">Eligibility</th>
                            <th style="padding:10px; border:1px solid #ddd;">Remarks</th>
                            <th style="padding:10px; border:1px solid #ddd;">Version</th>
                            <th style="padding:10px; border:1px solid #ddd;">Created Date</th>
                            <th style="padding:10px; border:1px solid #ddd;">Updated Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var a in applications)
                        {
                            <tr style="background:@(applications.IndexOf(a) % 2 == 0 ? "#fff" : "#f9f9f9");">
                                <td style="padding:8px; border:1px solid #eee;">@a.SerialNumber</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.OriginalSlumNumber</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.OriginalSlumDwellerName</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.ApplicantName</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.VoterListYear</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.VoterListPartNumber</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.VoterListSerialNumber</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.VoterListBound</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.SlumUsage</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.CarpetAreaSqFt</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.EvidenceDetails</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.EligibilityStatus</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.Remarks</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.Version</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.CreatedDate</td>
                                <td style="padding:8px; border:1px solid #eee;">@a.UpdatedDate</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div style="text-align:center; padding:20px; color:#666;">
                    No applications found. Import an Excel file to get started.
                </div>
            }
        </div>
    </BitStack>
</section>
<script>
    function downloadFile(fileName, contentType, base64Data) {
        const link = document.createElement("a");
        link.href = "data:" + contentType + ";base64," + base64Data;
        link.download = fileName;
        link.click();
    }
</script>