@inherits AppComponentBase

@* @if (isOtpSent || requiresTwoFactor)
{
    <!-- Check out ShowSignInPanel's comments -->
    <NavigationLock OnBeforeInternalNavigation="HideTfaAndOtpPanels" />
} *@

<section class="signin-container">
    <div class="signin-card">
        <div class="signin-header">
            <div class="logo-container">
                <BitIcon IconName="@BitIconName.Signin" Size="BitSize.Large" Color="BitColor.Primary" />
            </div>
            <BitText Typography="BitTypography.H3" Class="signin-title">
                @Localizer[nameof(AppStrings.SignInPanelTitle)]
            </BitText>
            <BitText Typography="BitTypography.Body1" Color="BitColor.SecondaryForeground" Class="signin-subtitle">
                Welcome back! Please sign in to your account
            </BitText>
        </div>

        <EditForm Model="model" OnSubmit="WrapHandled(DoSignIn)" novalidate class="signin-form">
            <AppDataAnnotationsValidator @ref="validatorRef" />

            <div class="signin-content">
                @if (requiresTwoFactor is false)
                {
                    @if (isOtpSent is false)
                    {
                        <div class="form-container">

                            <div class="form-fields">
                                <div class="input-group">
                                    <BitTextField @bind-Value="model.Email"
                                                  TabIndex="1"
                                                  Type="BitInputType.Email"
                                                  Immediate DebounceTime="500"
                                                  Label="@Localizer[nameof(AppStrings.UserName)]"
                                                  Placeholder="@Localizer[nameof(AppStrings.UserNamePlaceholder)]"
                                                  Class="form-input" />
                                    <ValidationMessage For="@(() => model.Email)" Class="validation-message" />
                                </div>

                                @if (internalSignInPanelType is SignInPanelType.Full or SignInPanelType.Password)
                                {
                                    <div class="input-group">
                                        <BitTextField @bind-Value="model.Password"
                                                      TabIndex="2"
                                                      CanRevealPassword="true"
                                                      Type="BitInputType.Password"
                                                      AutoComplete="@BitAutoCompleteValue.CurrentPassword"
                                                      Placeholder="@Localizer[nameof(AppStrings.PasswordPlaceholder)]"
                                                      Class="form-input">
                                            <LabelTemplate>
                                                <div class="password-label">
                                                    <BitText>@Localizer[nameof(AppStrings.Password)]</BitText>
                                                    <BitLink Href="@($"{PageUrls.ForgotPassword}?return-url={Uri.EscapeDataString(GetReturnUrl())}")" 
                                                             Class="forgot-password-link">
                                                        @Localizer[nameof(AppStrings.ForgotPasswordLink)]
                                                    </BitLink>
                                                </div>
                                            </LabelTemplate>
                                        </BitTextField>
                                        <ValidationMessage For="@(() => model.Password)" Class="validation-message" />
                                    </div>
                                }
                            </div>

                            <div class="form-options">
                                <div class="remember-me-section">
                                    <BitCheckbox @bind-Value="model.RememberMe" 
                                                  Label="@Localizer[nameof(AppStrings.RememberMe)]" 
                                                  Class="remember-me-checkbox" />
                                    @if (showWebAuthn)
                                    {
                                        <BitButton IconOnly
                                                   Size="BitSize.Large"
                                                   IsLoading="isWaiting"
                                                   Variant="BitVariant.Text"
                                                   Color="BitColor.Tertiary"
                                                   IsEnabled="isWaiting is false"
                                                   ButtonType="BitButtonType.Button"
                                                   IconName="@BitIconName.Fingerprint"
                                                   OnClick="WrapHandled(PasswordlessSignIn)"
                                                   Class="biometric-button"
                                                   Title="Sign in with biometric" />
                                    }
                                </div>
                            </div>

                            @if (internalSignInPanelType is SignInPanelType.Full or SignInPanelType.Password)
                            {
                                <div class="submit-section">
                                    @if (internalSignInPanelType is SignInPanelType.Password)
                                    {
                                        <div class="password-message">
                                            <BitText Typography="BitTypography.Body2" Align="BitTextAlign.Center">
                                                <strong>@Localizer[nameof(AppStrings.SignInPasswordMessage1)]</strong>
                                                <br />
                                                @Localizer[nameof(AppStrings.SignInPasswordMessage2)]
                                            </BitText>
                                        </div>
                                    }
                                    <BitButton IsLoading="isWaiting"
                                               IsEnabled="isWaiting is false"
                                               ButtonType="BitButtonType.Submit"
                                               Class="signin-button">
                                        @Localizer[nameof(AppStrings.Continue)]
                                    </BitButton>
                                </div>
                            } 

                        </div>
                    }
                    else
                    {
                        <div class="otp-container">
                            <OtpPanel Model="model"
                                      OnSignIn="DoSignIn"
                                      IsWaiting="isWaiting"
                                      OnResendOtp="WrapHandled(() => SendOtp(resend:true))" />
                        </div>
                    }
                }
                else
                {
                    <div class="tfa-container">
                        <TfaPanel model="model"
                                  IsWaiting="isWaiting"
                                  OnTokenProvided="DoSignIn"
                                  OnSendTfaToken="WrapHandled(SendTfaToken)" />
                    </div>
                }
            </div>
        </EditForm>

        @if (internalSignInPanelType is SignInPanelType.Full)
        {
            <div class="signin-footer">
                <BitText Align="BitTextAlign.Center" Typography="BitTypography.Body2" Class="signup-message">
                    @Localizer[nameof(AppStrings.DontHaveAccountMessage)]
                    <BitLink Href="@($"{PageUrls.SignUp}?return-url={Uri.EscapeDataString(GetReturnUrl())}")" 
                             Class="signup-link">
                        @Localizer[nameof(AppStrings.SignUp)]
                    </BitLink>
                </BitText>
            </div>
        }
    </div>
</section>
<style>
    .signin-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, $bit-color-background-primary 0%, $bit-color-background-secondary 100%);
        padding: 2rem;
        min-height: 100vh;
        include lt-md

    {
        padding: 1rem;
        min-height: 100vh;
    }

    }

    .signin-card {
        background: $bit-color-background-primary;
        border-radius: 16px;
        box-shadow: $bit-box-shadow-4;
        padding: 3rem;
        width: 100%;
        max-width: 420px;
        border: 1px solid $bit-color-border-secondary;
        include lt-md

    {
        padding: 2rem;
        max-width: 100%;
        border-radius: 12px;
    }

    include lt-sm {
        padding: 1.5rem;
        border-radius: 8px;
    }

    }

    .signin-header {
        text-align: center;
        margin-bottom: 2rem;
        .logo-container

    {
        margin-bottom: 1.5rem;
        :: deep .bit-icon

    {
        font-size: 3rem;
        color: $bit-color-primary;
    }

    }

    .signin-title {
        margin-bottom: 0.5rem;
        color: $bit-color-foreground-primary;
        font-weight: 600;
    }

    .signin-subtitle {
        color: $bit-color-foreground-secondary;
        line-height: 1.5;
    }

    }

    .signin-form {
        width: 100%;
    }

    .signin-content {
        width: 100%;
    }

    .form-container {
        width: 100%;
    }

    .form-fields {
        margin-bottom: 1.5rem;
        .input-group

    {
        margin-bottom: 1.5rem;
        &:last-child

    {
        margin-bottom: 0;
    }

    }
    }

    .form-input {
        :: deep .bit-txt

    {
        border-radius: 8px;
        border: 2px solid $bit-color-border-secondary;
        transition: all 0.2s ease;
        font-size: 16px;
        padding: 0.875rem 1rem;
        &:focus-within

    {
        border-color: $bit-color-primary;
        box-shadow: 0 0 0 3px rgba($bit-color-primary, 0.1);
    }

    &:hover {
        border-color: $bit-color-border-primary;
    }

    }

    ::deep .bit-txt-label {
        font-weight: 500;
        color: $bit-color-foreground-primary;
        margin-bottom: 0.5rem;
        font-size: 14px;
    }

    }

    .password-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        .forgot-password-link

    {
        color: $bit-color-primary;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: color 0.2s ease;
        &:hover

    {
        color: $bit-color-primary-hover;
        text-decoration: underline;
    }

    }
    }

    .form-options {
        margin-bottom: 2rem;
        .remember-me-section

    {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        .remember-me-checkbox

    {
        :: deep .bit-chb

    {
        font-size: 14px;
        color: $bit-color-foreground-secondary;
    }

    }

    .biometric-button {
        :: deep .bit-btn

    {
        border-radius: 50%;
        width: 48px;
        height: 48px;
        transition: all 0.2s ease;
        &:hover

    {
        background-color: $bit-color-background-secondary;
        transform: scale(1.05);
    }

    }
    }
    }
    }

    .submit-section {
        .password-message

    {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: $bit-color-background-secondary;
        border-radius: 8px;
        border-left: 4px solid $bit-color-primary;
        :: deep .bit-txt

    {
        color: $bit-color-foreground-secondary;
        line-height: 1.5;
    }

    }

    .signin-button {
        width: 100%;
        height: 48px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.2s ease;
        :: deep .bit-btn

    {
        background-color: $bit-color-primary;
        border: none;
        color: $bit-color-primary-text;
        font-weight: 600;
        text-transform: none;
        letter-spacing: 0.5px;
        &:hover

    {
        background-color: $bit-color-primary-hover;
        transform: translateY(-1px);
        box-shadow: $bit-box-shadow-2;
    }

    &:active {
        transform: translateY(0);
    }

    &:disabled {
        background-color: $bit-color-background-disabled;
        color: $bit-color-foreground-disabled;
        transform: none;
        box-shadow: none;
    }

    }
    }
    }

    .otp-container,
    .tfa-container {
        padding: 1rem 0;
    }

    .signin-footer {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid $bit-color-border-secondary;
        .signup-message

    {
        color: $bit-color-foreground-secondary;
        line-height: 1.5;
        .signup-link

    {
        color: $bit-color-primary;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
        &:hover

    {
        color: $bit-color-primary-hover;
        text-decoration: underline;
    }

    }
    }
    }

    .validation-message {
        color: $bit-color-danger;
        font-size: 12px;
        margin-top: 0.25rem;
        display: block;
        font-weight: 500;
    }

    // Responsive adjustments
    include lt-md {
        .signin-card

    {
        box-shadow: $bit-box-shadow-2;
    }

    .signin-header {
        margin-bottom: 1.5rem;
        .logo-container

    {
        margin-bottom: 1rem;
    }

    }

    .form-fields {
        margin-bottom: 1rem;
        .input-group

    {
        margin-bottom: 1rem;
    }

    }

    .form-options {
        margin-bottom: 1.5rem;
    }

    .submit-section {
        .password-message

    {
        margin-bottom: 1rem;
        padding: 0.75rem;
    }

    }
    }

    include lt-sm {
        .signin-container

    {
        padding: 0.5rem;
    }

    .signin-card {
        padding: 1rem;
    }

    .signin-header {
        margin-bottom: 1rem;
        .logo-container

    {
        margin-bottom: 0.75rem;
    }

    }

    .form-input {
        :: deep .bit-txt

    {
        font-size: 16px;
        // Prevent zoom on iOS padding: 0.75rem;
    }

    }

    .submit-section {
        .signin-button

    {
        height: 44px;
        font-size: 15px;
    }

    }
    }

    // Dark theme adjustments
    :root[bit-theme="dark"] {
        .signin-container

    {
        background: linear-gradient(135deg, $bit-color-background-primary 0%, $bit-color-background-secondary 100%);
    }

    .signin-card {
        background: $bit-color-background-primary;
        border-color: $bit-color-border-primary;
    }

    }

    ::deep {
        .lg-sep

    {
        include lt-md

    {
        display: none;
    }

    }

    .sm-sep {
        include gt-sm

    {
        display: none;
    }

    }
    }</style>